<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self';
                   style-src 'self' 'unsafe-inline';
                   img-src 'self' data:;
                   connect-src 'self';
                   font-src 'self';
                   object-src 'none';
                   base-uri 'self';
                   form-action 'self';">
    <title>Spectral Synthesizer - Hear Molecules</title>
    <meta name="description" content="Making molecular fingerprints audible through sonification of FTIR spectroscopy data">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body data-theme="dark">
    <header role="banner">
        <div class="header-content">
            <div class="header-title">
                <h1>üéµ Spectral Synthesizer</h1>
                <p class="tagline">Making molecular fingerprints audible through sonification</p>
            </div>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle light/dark theme" title="Toggle theme">
                <span class="theme-icon">‚òÄÔ∏è</span>
            </button>
        </div>
    </header>

    <main role="main">
        <section class="info-panel" aria-label="Introduction">
            <h2>The Connection</h2>
            <p>
                FTIR spectroscopy and audio both use <strong>Fourier transforms</strong> to decompose signals
                into frequency components. This tool maps infrared absorption spectra (molecular vibrations)
                down to audible frequencies, revealing what molecules "sound like".
            </p>
            <p style="margin-top: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.15); border-left: 3px solid #8b5cf6; border-radius: 4px;">
                <strong>Now using real data!</strong> This version includes 381 authentic FTIR spectra from the
                <a href="https://enfsi.eu/" target="_blank" style="color: #a78bfa;">ENFSI DWG IR Library</a>
                (European Network of Forensic Science Institutes), providing scientifically accurate molecular fingerprints.
            </p>
        </section>

        <section class="mode-selector" role="group" aria-label="View mode selection">
            <button id="single-mode" class="mode-button active" aria-pressed="true">Single View</button>
            <button id="comparison-mode" class="mode-button" aria-pressed="false">Comparison Mode</button>
        </section>

        <section class="controls" id="single-controls" aria-label="Playback controls">
            <div class="filter-controls" role="group" aria-label="Substance filters">
                <div class="search-box">
                    <label for="search">Search substances:</label>
                    <input type="text" id="search" placeholder="Type to search..." />
                </div>

                <div class="category-filter">
                    <label for="category">Filter by category:</label>
                    <select id="category">
                        <option value="all">All Categories</option>
                        <option value="opioids">Opioids</option>
                        <option value="stimulants">Stimulants</option>
                        <option value="benzodiazepines">Benzodiazepines</option>
                        <option value="psychedelics">Psychedelics</option>
                        <option value="cannabinoids">Cannabinoids</option>
                        <option value="steroids">Steroids</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="results-count">
                    <span id="results-count">381 substances</span>
                </div>
            </div>

            <div class="favorites-filter">
                <label for="show-favorites">
                    <input type="checkbox" id="show-favorites">
                    ‚≠ê Show Favorites Only
                </label>
            </div>

            <div class="substance-selector">
                <label for="substance">
                    Select a substance:
                    <button id="favorite-toggle" class="favorite-button" type="button" aria-label="Toggle favorite" style="display: none;">‚òÜ</button>
                </label>
                <select id="substance">
                    <option value="">-- Loading library... --</option>
                </select>
            </div>

            <div class="playback-controls" role="group" aria-label="Playback buttons">
                <button id="play" disabled aria-label="Play sound from selected substance">‚ñ∂ Play Sound</button>
                <button id="stop" disabled aria-label="Stop playback">‚ñ† Stop</button>
                <div class="slider-control">
                    <label for="duration">Duration: <span id="duration-value">2.0</span>s</label>
                    <input type="range" id="duration" min="0.5" max="5" step="0.1" value="2">
                </div>
                <div class="slider-control">
                    <label for="volume">Volume: <span id="volume-value">50</span>%</label>
                    <input type="range" id="volume" min="0" max="100" step="1" value="50">
                </div>
            </div>

            <div class="collapsible-section audio-effects">
                <h4 class="section-header collapsible-header" data-section="audio-effects">
                    <span class="collapse-icon">‚ñº</span>
                    Audio Effects
                </h4>
                <div class="collapsible-content" id="audio-effects-content">
                    <div class="effects-grid">
                        <div class="slider-control">
                            <label for="reverb">Reverb: <span id="reverb-value">0</span>%</label>
                            <input type="range" id="reverb" min="0" max="100" step="1" value="0">
                        </div>
                        <div class="slider-control">
                            <label for="filter-freq">Filter: <span id="filter-freq-value">8000</span> Hz</label>
                            <input type="range" id="filter-freq" min="100" max="8000" step="100" value="8000">
                        </div>
                    </div>
                    <div class="preset-controls">
                        <label for="preset-select">Presets:</label>
                        <select id="preset-select" aria-label="Select audio effect preset">
                            <option value="">-- Select Preset --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="collapsible-section adsr-controls" role="group" aria-label="ADSR envelope controls">
                <h4 class="section-header collapsible-header" data-section="adsr">
                    <span class="collapse-icon">‚ñº</span>
                    ADSR Envelope
                </h4>
                <div class="collapsible-content" id="adsr-content">
                    <div class="adsr-grid">
                        <div class="slider-control">
                            <label for="attack">Attack: <span id="attack-value">50</span> ms</label>
                            <input type="range" id="attack" min="1" max="2000" step="1" value="50">
                        </div>
                        <div class="slider-control">
                            <label for="decay">Decay: <span id="decay-value">100</span> ms</label>
                            <input type="range" id="decay" min="1" max="2000" step="1" value="100">
                        </div>
                        <div class="slider-control">
                            <label for="sustain">Sustain: <span id="sustain-value">70</span>%</label>
                            <input type="range" id="sustain" min="0" max="100" step="1" value="70">
                        </div>
                        <div class="slider-control">
                            <label for="release">Release: <span id="release-value">100</span> ms</label>
                            <input type="range" id="release" min="1" max="3000" step="1" value="100">
                        </div>
                    </div>
                    <div class="adsr-curve-controls">
                        <label for="adsr-curve-select">Curve Type:</label>
                        <select id="adsr-curve-select" aria-label="Select ADSR curve type">
                            <!-- Options populated dynamically from config.js -->
                        </select>
                    </div>
                </div>
            </div>

            <div class="collapsible-section playback-mode-controls" role="group" aria-label="Playback mode controls">
                <h4 class="section-header collapsible-header" data-section="playback-mode">
                    <span class="collapse-icon">‚ñº</span>
                    Playback Mode
                </h4>
                <div class="collapsible-content" id="playback-mode-content">
                    <div class="playback-mode-selector">
                        <label for="playback-mode-select">Mode:</label>
                        <select id="playback-mode-select" aria-label="Select playback mode">
                            <!-- Options populated dynamically from config.js -->
                        </select>
                    </div>
                </div>
            </div>

            <div class="collapsible-section import-export-controls" role="group" aria-label="Import and export controls">
                <h4 class="section-header collapsible-header" data-section="import-export">
                    <span class="collapse-icon">‚ñº</span>
                    Import & Export
                </h4>
                <div class="collapsible-content" id="import-export-content">
                    <div class="import-export-grid">
                        <div class="import-section">
                            <label for="csv-import" class="file-label">
                                üìÅ Import CSV
                            </label>
                            <input type="file" id="csv-import" accept=".csv" style="display: none;" aria-label="Import FTIR data from CSV file">
                            <button id="download-template" class="secondary-button" aria-label="Download CSV template">
                                üìã Download Template
                            </button>
                        </div>
                        <div class="export-section">
                            <button id="export-wav" disabled class="secondary-button" aria-label="Export audio as WAV file">
                                üíæ Export WAV
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section peak-selection-controls" role="group" aria-label="Peak selection controls">
                <h4 class="section-header collapsible-header" data-section="peak-selection">
                    <span class="collapse-icon">‚ñº</span>
                    Peak Selection
                </h4>
                <div class="collapsible-content" id="peak-selection-content">
                    <div class="selection-info" role="status" aria-live="polite">
                        <span id="selection-count">Click peaks on the FTIR spectrum to select them</span>
                    </div>
                    <div class="selection-buttons">
                        <button id="play-selected" disabled aria-label="Play only selected peaks">‚ñ∂ Play Selected</button>
                        <button id="select-all" disabled aria-label="Select all peaks">Select All</button>
                        <button id="clear-selection" disabled aria-label="Clear peak selection">Clear Selection</button>
                    </div>
                </div>
            </div>

            <div class="smart-suggestions" id="smart-suggestions" style="display: none;" role="group" aria-label="Similar substances">
                <h4 class="section-title">‚ú® Similar Substances</h4>
                <p class="suggestions-description">Based on spectral similarity</p>
                <div class="suggestions-list" id="suggestions-list"></div>
            </div>
        </section>

        <section class="controls comparison-controls" id="comparison-controls" style="display: none;">
            <div class="comparison-grid">
                <div class="comparison-side">
                    <h3 class="comparison-title">Substance A</h3>
                    <div class="substance-selector">
                        <label for="substance-a">Select substance:</label>
                        <select id="substance-a">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="comparison-playback">
                        <button id="play-a" disabled>‚ñ∂ Play A</button>
                    </div>
                </div>

                <div class="comparison-side">
                    <h3 class="comparison-title">Substance B</h3>
                    <div class="substance-selector">
                        <label for="substance-b">Select substance:</label>
                        <select id="substance-b">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="comparison-playback">
                        <button id="play-b" disabled>‚ñ∂ Play B</button>
                    </div>
                </div>
            </div>

            <div class="comparison-combined">
                <button id="play-both-sequential" disabled>‚ñ∂ Play A ‚Üí B (Sequential)</button>
                <button id="play-both-simultaneous" disabled>‚ñ∂ Play A + B (Simultaneous)</button>
            </div>

            <div class="slider-control">
                <label for="comparison-duration">Duration: <span id="comparison-duration-value">2.0</span>s</label>
                <input type="range" id="comparison-duration" min="0.5" max="5" step="0.1" value="2">
            </div>
        </section>

        <section class="visualization single-visualization" aria-label="Visualization">
            <div class="viz-panel">
                <h3>FTIR Spectrum (Infrared)</h3>
                <canvas id="ftir-canvas" width="600" height="300" role="img" aria-label="FTIR spectrum visualization"></canvas>
                <div class="axis-labels">
                    <span class="axis-label-x">Wavenumber (cm‚Åª¬π)</span>
                    <span class="axis-label-y">Transmittance (%)</span>
                </div>
            </div>

            <div class="viz-panel">
                <h3>Audio FFT (Audible)</h3>
                <canvas id="audio-canvas" width="600" height="300" role="img" aria-label="Audio FFT visualization"></canvas>
                <div class="axis-labels">
                    <span class="axis-label-x">Frequency (Hz)</span>
                    <span class="axis-label-y">Amplitude</span>
                </div>
            </div>
        </section>

        <section class="visualization comparison-visualization" id="comparison-visualization" style="display: none;">
            <div class="comparison-viz-grid">
                <div class="viz-panel">
                    <h3>Substance A - FTIR Spectrum</h3>
                    <canvas id="ftir-canvas-a" width="600" height="300"></canvas>
                    <div class="axis-labels">
                        <span class="axis-label-x">Wavenumber (cm‚Åª¬π)</span>
                        <span class="axis-label-y">Transmittance (%)</span>
                    </div>
                </div>

                <div class="viz-panel">
                    <h3>Substance B - FTIR Spectrum</h3>
                    <canvas id="ftir-canvas-b" width="600" height="300"></canvas>
                    <div class="axis-labels">
                        <span class="axis-label-x">Wavenumber (cm‚Åª¬π)</span>
                        <span class="axis-label-y">Transmittance (%)</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="info-panel">
            <h2>Keyboard Shortcuts</h2>
            <div class="keyboard-shortcuts">
                <div class="shortcut-grid">
                    <div class="shortcut-item">
                        <kbd>Space</kbd>
                        <span>Play / Stop</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>‚Üë</kbd> / <kbd>‚Üì</kbd>
                        <span>Navigate substances</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>A</kbd>
                        <span>Select all peaks</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>C</kbd>
                        <span>Clear peak selection</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Esc</kbd>
                        <span>Clear search/filters</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="info-panel">
            <h2>Understanding the Mapping</h2>
            <div id="mapping-info" class="mapping-info">
                <p>Select a substance to see how infrared frequencies map to audio frequencies.</p>
            </div>
        </section>

        <section class="info-panel">
            <h2>The Science</h2>
            <div class="science-explanation">
                <h3>Why molecules absorb infrared light</h3>
                <p>
                    Chemical bonds vibrate at specific frequencies. When infrared light matches these
                    vibrational frequencies, the molecule absorbs that light. Different molecular structures
                    create different absorption patterns - a unique "fingerprint".
                </p>

                <h3>The Fourier Transform connection</h3>
                <p>
                    Both FTIR and audio analysis use the same mathematical tool: the Fourier Transform.
                    It decomposes complex signals into individual frequency components. In FTIR, we're
                    analyzing molecular vibrations (~10¬π¬≥ Hz). In audio, we're analyzing sound waves (~100-10000 Hz).
                </p>

                <h3>The sonification process</h3>
                <ol>
                    <li>Extract absorption peaks from FTIR spectrum</li>
                    <li>Map IR wavenumbers (400-4000 cm‚Åª¬π) to audio frequencies (20-20000 Hz) logarithmically</li>
                    <li>Create oscillators at mapped frequencies with amplitudes based on absorption intensity</li>
                    <li>Synthesize the sound and visualize its FFT in real-time</li>
                </ol>
            </div>
        </section>
    </main>

    <footer role="contentinfo">
        <p>
            <strong>Note:</strong> This is an educational/artistic tool, not for substance identification or drug checking.
            FTIR data sourced from scientific databases.
        </p>
    </footer>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Screen reader announcements -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only">
        <span id="playback-status"></span>
    </div>

    <!-- Peak tooltip -->
    <div id="peak-tooltip" class="peak-tooltip" role="tooltip" style="display: none;">
        <div class="tooltip-header"></div>
        <div class="tooltip-content"></div>
    </div>

    <!-- Onboarding modal -->
    <div id="onboarding-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="onboarding-title" aria-modal="true">
        <div class="modal-content onboarding-modal">
            <button class="modal-close" id="onboarding-close" aria-label="Close welcome message">&times;</button>
            <h2 id="onboarding-title">Welcome to Spectral Synthesizer! üéµ</h2>

            <div class="onboarding-section">
                <div class="onboarding-illustration">
                    <svg width="300" height="150" viewBox="0 0 300 150" xmlns="http://www.w3.org/2000/svg">
                        <!-- Molecule -->
                        <circle cx="50" cy="75" r="15" fill="#8b5cf6" opacity="0.8"/>
                        <circle cx="80" cy="60" r="12" fill="#a78bfa" opacity="0.8"/>
                        <circle cx="80" cy="90" r="12" fill="#a78bfa" opacity="0.8"/>
                        <line x1="50" y1="75" x2="80" y2="60" stroke="#c4b5fd" stroke-width="3"/>
                        <line x1="50" y1="75" x2="80" y2="90" stroke="#c4b5fd" stroke-width="3"/>

                        <!-- Arrow -->
                        <path d="M 110 75 L 130 75 L 125 70 M 130 75 L 125 80" stroke="#ec4899" stroke-width="2" fill="none"/>
                        <text x="140" y="80" fill="#ec4899" font-size="14" font-weight="bold">FFT</text>

                        <!-- Spectrum waves -->
                        <path d="M 180 75 Q 190 60, 200 75 T 220 75 Q 230 90, 240 75 T 260 75" stroke="#8b5cf6" stroke-width="2" fill="none"/>
                        <path d="M 180 85 Q 190 70, 200 85 T 220 85 Q 230 100, 240 85 T 260 85" stroke="#a78bfa" stroke-width="2" fill="none" opacity="0.6"/>

                        <!-- Sound waves -->
                        <circle cx="280" cy="75" r="8" fill="none" stroke="#ec4899" stroke-width="1.5" opacity="0.8"/>
                        <circle cx="280" cy="75" r="15" fill="none" stroke="#ec4899" stroke-width="1" opacity="0.4"/>
                    </svg>
                </div>

                <p class="onboarding-tagline">Making Molecular Fingerprints Audible</p>

                <p class="onboarding-description">
                    Every molecule absorbs infrared light at specific frequencies, creating a unique "fingerprint."
                    This tool maps those molecular vibrations (10¬π¬≥ Hz) down to audible sound (100-8000 Hz).
                </p>

                <div class="onboarding-highlight">
                    <strong>Same math (Fourier Transform), different data!</strong><br>
                    Left panel: FTIR spectrum | Right panel: Audio FFT
                </div>
            </div>

            <div class="onboarding-suggestions">
                <h3>Try These First:</h3>
                <div class="suggestion-pills">
                    <button class="suggestion-pill" data-substance-id="mdma">MDMA</button>
                    <button class="suggestion-pill" data-substance-id="cocaine">Cocaine</button>
                    <button class="suggestion-pill" data-substance-id="caffeine">Caffeine</button>
                </div>
            </div>

            <div class="onboarding-actions">
                <button id="start-tour" class="primary-button">Take the Tour</button>
                <button id="skip-tour" class="secondary-button">Explore on My Own</button>
            </div>

            <label class="onboarding-checkbox">
                <input type="checkbox" id="dont-show-again">
                Don't show this again
            </label>
        </div>
    </div>

    <!-- Keyboard shortcuts overlay -->
    <div id="shortcuts-overlay" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="shortcuts-title" aria-modal="true">
        <div class="modal-content shortcuts-modal">
            <button class="modal-close" id="shortcuts-close" aria-label="Close shortcuts">&times;</button>
            <h2 id="shortcuts-title">‚å®Ô∏è Keyboard Shortcuts</h2>

            <div class="shortcuts-grid">
                <div class="shortcut-row">
                    <kbd>Space</kbd>
                    <span>Play / Stop</span>
                </div>
                <div class="shortcut-row">
                    <kbd>‚Üë</kbd> / <kbd>‚Üì</kbd>
                    <span>Navigate substances</span>
                </div>
                <div class="shortcut-row">
                    <kbd>A</kbd>
                    <span>Select all peaks</span>
                </div>
                <div class="shortcut-row">
                    <kbd>C</kbd>
                    <span>Clear peak selection</span>
                </div>
                <div class="shortcut-row">
                    <kbd>Esc</kbd>
                    <span>Clear search/filters</span>
                </div>
                <div class="shortcut-row">
                    <kbd>?</kbd>
                    <span>Show this help</span>
                </div>
            </div>

            <button id="shortcuts-ok" class="primary-button" style="margin-top: 1.5rem;">Got it!</button>
        </div>
    </div>

    <!-- Configuration must be loaded first -->
    <script src="config.js"></script>
    
    <!-- Core modules -->
    <script src="frequency-mapper.js"></script>
    <script src="audio-engine.js"></script>
    <script src="visualizer.js"></script>
    <script src="csv-importer.js"></script>
    
    <!-- Main application -->
    <script src="app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('‚úì Service Worker registered:', registration.scope);

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
