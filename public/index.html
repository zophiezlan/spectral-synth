<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self';
                   style-src 'self' 'unsafe-inline';
                   img-src 'self' data:;
                   connect-src 'self';
                   font-src 'self';
                   object-src 'none';
                   base-uri 'self';
                   form-action 'self';">
    <title>Spectral Synthesizer - Hear Molecules</title>
    <meta name="description" content="Making molecular fingerprints audible through sonification of FTIR spectroscopy data">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="stylesheet" href="styles/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body data-theme="dark">
    <header role="banner">
        <div class="header-content">
            <button id="burger-menu-btn" class="burger-menu" aria-label="Open menu" aria-expanded="false">
                <span class="burger-line"></span>
                <span class="burger-line"></span>
                <span class="burger-line"></span>
            </button>
            <div class="header-title">
                <h1>Spectral Synthesizer</h1>
                <p class="tagline">Making molecular fingerprints audible through sonification</p>
            </div>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle light/dark theme" title="Toggle theme">
                <span class="theme-icon">‚òÄÔ∏è</span>
            </button>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <div id="sidebar-overlay" class="sidebar-overlay hidden" aria-hidden="true"></div>
    <nav id="sidebar" class="sidebar hidden" aria-label="Main navigation">
        <div class="sidebar-header">
            <h2>Menu</h2>
            <button id="sidebar-close" class="sidebar-close" aria-label="Close menu">&times;</button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <button id="settings-menu-btn" class="sidebar-button" aria-label="Open settings">
                    <span class="sidebar-icon">‚öôÔ∏è</span>
                    <span class="sidebar-label">Settings</span>
                </button>
            </li>
            <li>
                <button id="import-export-menu-btn" class="sidebar-button" aria-label="Import/Export">
                    <span class="sidebar-icon">üì•</span>
                    <span class="sidebar-label">Import/Export</span>
                </button>
            </li>
            <li>
                <button id="midi-menu-btn" class="sidebar-button" aria-label="MIDI options">
                    <span class="sidebar-icon">üéπ</span>
                    <span class="sidebar-label">MIDI</span>
                </button>
            </li>
            <li>
                <button id="help-menu-btn" class="sidebar-button" aria-label="Help and information">
                    <span class="sidebar-icon">‚ùì</span>
                    <span class="sidebar-label">Help</span>
                </button>
            </li>
        </ul>
    </nav>

    <main role="main">
        <section class="controls" id="single-controls" aria-label="Playback controls">
            <div class="filter-controls" role="group" aria-label="Substance filters">
                <div class="search-box">
                    <label for="search">Search substances:</label>
                    <input type="text" id="search" placeholder="Type to search..." />
                </div>

                <div class="category-filter">
                    <label for="category">Filter by category:</label>
                    <select id="category">
                        <option value="all">All Categories</option>
                        <option value="opioids">Opioids</option>
                        <option value="stimulants">Stimulants</option>
                        <option value="benzodiazepines">Benzodiazepines</option>
                        <option value="psychedelics">Psychedelics</option>
                        <option value="cannabinoids">Cannabinoids</option>
                        <option value="steroids">Steroids</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="favorites-filter-buttons">
                    <button id="show-all" class="filter-button active" aria-pressed="true">All</button>
                    <button id="show-favorites" class="filter-button" aria-pressed="false">‚≠ê Favorites</button>
                </div>

                <div class="results-count">
                    <span id="results-count">381 substances</span>
                </div>
            </div>

            <div class="substance-selector">
                <label for="substance">
                    Select a substance:
                    <button id="favorite-toggle" class="favorite-button hidden" type="button" aria-label="Toggle favorite">‚òÜ</button>
                </label>
                <select id="substance">
                    <option value="">-- Loading library... --</option>
                </select>
            </div>

            <div class="playback-controls" role="group" aria-label="Playback buttons">
                <button id="play" class="primary-button" disabled aria-label="Play sound from selected substance">‚ñ∂ Play Sound</button>
                <button id="stop" class="secondary-button" disabled aria-label="Stop playback">‚ñ† Stop</button>
                <div class="slider-control">
                    <label for="duration">Duration: <span id="duration-value">2.0</span>s</label>
                    <input type="range" id="duration" min="0.5" max="5" step="0.1" value="2">
                </div>
                <div class="slider-control">
                    <label for="volume">Volume: <span id="volume-value">50</span>%</label>
                    <input type="range" id="volume" min="0" max="100" step="1" value="50">
                </div>
            </div>
        </section>

        <section class="visualization single-visualization" aria-label="Visualization">
            <div class="viz-panel">
                <div class="viz-header">
                    <h3>FTIR Spectrum (Infrared)</h3>
                    <button id="mapping-info-btn" class="info-icon-btn" aria-label="Understanding the mapping" title="Understanding the mapping">
                        <span class="info-icon">‚ÑπÔ∏è</span>
                    </button>
                </div>
                <canvas id="ftir-canvas" width="600" height="300" role="img" aria-label="FTIR spectrum visualization"></canvas>
                <div class="axis-labels">
                    <span class="axis-label-x">Wavenumber (cm‚Åª¬π)</span>
                    <span class="axis-label-y">Transmittance (%)</span>
                </div>
                <div class="peak-selection-info">
                    <span id="selection-count" class="selection-status">Click peaks to select specific frequencies</span>
                    <button id="clear-selection" class="clear-selection-btn hidden" aria-label="Clear peak selection">Clear Selection</button>
                </div>
            </div>

            <div class="viz-panel">
                <h3>Audio FFT (Audible)</h3>
                <canvas id="audio-canvas" width="600" height="300" role="img" aria-label="Audio FFT visualization"></canvas>
                <div class="axis-labels">
                    <span class="axis-label-x">Frequency (Hz)</span>
                    <span class="axis-label-y">Amplitude</span>
                </div>
            </div>
        </section>

        <div class="smart-suggestions hidden" id="smart-suggestions" role="group" aria-label="Similar substances">
            <h4 class="section-title">‚ú® Similar Substances</h4>
            <p class="suggestions-description">Based on spectral similarity</p>
            <div class="suggestions-list" id="suggestions-list"></div>
        </div>

    </main>

    <footer role="contentinfo">
        <p>
            <strong>Note:</strong> This is an educational/artistic tool, not for substance identification or drug checking.
            FTIR data sourced from scientific databases.
        </p>
    </footer>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Screen reader announcements -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only">
        <span id="playback-status"></span>
    </div>

    <!-- Peak tooltip -->
    <div id="peak-tooltip" class="peak-tooltip hidden" role="tooltip">
        <div class="tooltip-header"></div>
        <div class="tooltip-content"></div>
    </div>

    <!-- Onboarding modal -->
    <div id="onboarding-modal" class="modal-overlay hidden" role="dialog" aria-labelledby="onboarding-title" aria-modal="true">
        <div class="modal-content onboarding-modal">
            <button class="modal-close" id="onboarding-close" aria-label="Close welcome message">&times;</button>
            <h2 id="onboarding-title">Welcome to Spectral Synthesizer! üéµ</h2>

            <div class="onboarding-section">
                <div class="onboarding-illustration">
                    <svg width="300" height="150" viewBox="0 0 300 150" xmlns="http://www.w3.org/2000/svg">
                        <!-- Molecule -->
                        <circle cx="50" cy="75" r="15" fill="#8b5cf6" opacity="0.8"/>
                        <circle cx="80" cy="60" r="12" fill="#a78bfa" opacity="0.8"/>
                        <circle cx="80" cy="90" r="12" fill="#a78bfa" opacity="0.8"/>
                        <line x1="50" y1="75" x2="80" y2="60" stroke="#c4b5fd" stroke-width="3"/>
                        <line x1="50" y1="75" x2="80" y2="90" stroke="#c4b5fd" stroke-width="3"/>

                        <!-- Arrow -->
                        <path d="M 110 75 L 130 75 L 125 70 M 130 75 L 125 80" stroke="#ec4899" stroke-width="2" fill="none"/>
                        <text x="140" y="80" fill="#ec4899" font-size="14" font-weight="bold">FFT</text>

                        <!-- Spectrum waves -->
                        <path d="M 180 75 Q 190 60, 200 75 T 220 75 Q 230 90, 240 75 T 260 75" stroke="#8b5cf6" stroke-width="2" fill="none"/>
                        <path d="M 180 85 Q 190 70, 200 85 T 220 85 Q 230 100, 240 85 T 260 85" stroke="#a78bfa" stroke-width="2" fill="none" opacity="0.6"/>

                        <!-- Sound waves -->
                        <circle cx="280" cy="75" r="8" fill="none" stroke="#ec4899" stroke-width="1.5" opacity="0.8"/>
                        <circle cx="280" cy="75" r="15" fill="none" stroke="#ec4899" stroke-width="1" opacity="0.4"/>
                    </svg>
                </div>

                <p class="onboarding-tagline">Making Molecular Fingerprints Audible</p>

                <p class="onboarding-description">
                    Every molecule absorbs infrared light at specific frequencies, creating a unique "fingerprint."
                    This tool maps those molecular vibrations (10¬π¬≥ Hz) down to audible sound (100-8000 Hz).
                </p>

                <div class="onboarding-highlight">
                    <strong>Same math (Fourier Transform), different data!</strong><br>
                    Left panel: FTIR spectrum | Right panel: Audio FFT
                </div>

                <div class="onboarding-quick-tips">
                    <h4>Quick Navigation:</h4>
                    <ul>
                        <li>‚öôÔ∏è <strong>Settings</strong> - Adjust audio effects, ADSR envelope, playback mode</li>
                        <li>üì• <strong>Import/Export</strong> - Load your own data or save audio</li>
                        <li>üéπ <strong>MIDI</strong> - Connect to external synthesizers</li>
                        <li>‚ùì <strong>Help</strong> - Learn the science and keyboard shortcuts</li>
                    </ul>
                </div>
            </div>

            <div class="onboarding-suggestions">
                <h3>Try These First:</h3>
                <div class="suggestion-pills">
                    <button class="suggestion-pill" data-substance-id="mdma">MDMA</button>
                    <button class="suggestion-pill" data-substance-id="cocaine">Cocaine</button>
                    <button class="suggestion-pill" data-substance-id="caffeine">Caffeine</button>
                </div>
            </div>

            <div class="onboarding-actions">
                <button id="start-tour" class="primary-button">Take the Tour</button>
                <button id="skip-tour" class="secondary-button">Explore on My Own</button>
            </div>

            <label class="onboarding-checkbox">
                <input type="checkbox" id="dont-show-again">
                Don't show this again
            </label>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden" role="dialog" aria-labelledby="settings-title" aria-modal="true">
        <div class="modal-content settings-modal">
            <button class="modal-close" id="settings-close" aria-label="Close settings">&times;</button>
            <h2 id="settings-title">‚öôÔ∏è Settings</h2>

            <div class="settings-section">
                <h3>üéöÔ∏è Audio Effects</h3>
                <div class="effects-grid">
                    <div class="slider-control">
                        <label for="reverb">Reverb: <span id="reverb-value">0</span>%</label>
                        <input type="range" id="reverb" min="0" max="100" step="1" value="0">
                    </div>
                    <div class="slider-control">
                        <label for="filter-freq">Filter: <span id="filter-freq-value">8000</span> Hz</label>
                        <input type="range" id="filter-freq" min="100" max="8000" step="100" value="8000">
                    </div>
                </div>
                <div class="preset-controls">
                    <label for="preset-select">Presets:</label>
                    <select id="preset-select" aria-label="Select audio effect preset">
                        <option value="">-- Select Preset --</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>üìä ADSR Envelope</h3>
                <div class="adsr-grid">
                    <div class="slider-control">
                        <label for="attack">Attack: <span id="attack-value">50</span> ms</label>
                        <input type="range" id="attack" min="1" max="2000" step="1" value="50">
                    </div>
                    <div class="slider-control">
                        <label for="decay">Decay: <span id="decay-value">100</span> ms</label>
                        <input type="range" id="decay" min="1" max="2000" step="1" value="100">
                    </div>
                    <div class="slider-control">
                        <label for="sustain">Sustain: <span id="sustain-value">70</span>%</label>
                        <input type="range" id="sustain" min="0" max="100" step="1" value="70">
                    </div>
                    <div class="slider-control">
                        <label for="release">Release: <span id="release-value">100</span> ms</label>
                        <input type="range" id="release" min="1" max="3000" step="1" value="100">
                    </div>
                </div>
                <div class="adsr-curve-controls">
                    <label for="adsr-curve-select">Curve Type:</label>
                    <select id="adsr-curve-select" aria-label="Select ADSR curve type">
                        <!-- Options populated dynamically from config.js -->
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>üéµ Playback Mode</h3>
                <div class="playback-mode-selector">
                    <label for="playback-mode-select">Mode:</label>
                    <select id="playback-mode-select" aria-label="Select playback mode">
                        <!-- Options populated dynamically from config.js -->
                    </select>
                </div>
            </div>

            <button id="settings-ok" class="primary-button modal-action-button">Done</button>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div id="import-export-modal" class="modal-overlay hidden" role="dialog" aria-labelledby="import-export-title" aria-modal="true">
        <div class="modal-content import-export-modal">
            <button class="modal-close" id="import-export-close" aria-label="Close import/export">&times;</button>
            <h2 id="import-export-title">üì• Import & Export</h2>

            <div class="import-export-section">
                <h3>üìÅ Import Data</h3>
                <div class="import-buttons">
                    <label for="csv-import" class="file-label">
                        üìÅ Import CSV
                    </label>
                    <input type="file" id="csv-import" accept=".csv" class="hidden" aria-label="Import FTIR data from CSV file">
                    <label for="jcamp-import" class="file-label">
                        üìä Import JCAMP-DX
                    </label>
                    <input type="file" id="jcamp-import" accept=".jdx,.dx,.jcamp" class="hidden" aria-label="Import FTIR data from JCAMP-DX file">
                    <button id="download-template" class="secondary-button" aria-label="Download CSV template">
                        üìã Download Template
                    </button>
                </div>
            </div>

            <div class="import-export-section">
                <h3>üíæ Export Audio</h3>
                <div class="export-buttons">
                    <button id="export-wav" disabled class="secondary-button" aria-label="Export audio as WAV file">
                        üíæ Export WAV
                    </button>
                    <button id="export-mp3" disabled class="secondary-button" aria-label="Export audio as MP3 file">
                        üéµ Export MP3
                    </button>
                </div>
                <p class="import-export-info">Audio exports (WAV/MP3) use the current Playback Mode setting from Settings.</p>
            </div>

            <button id="import-export-ok" class="primary-button modal-action-button">Done</button>
        </div>
    </div>

    <!-- MIDI Modal -->
    <div id="midi-modal" class="modal-overlay hidden" role="dialog" aria-labelledby="midi-title" aria-modal="true">
        <div class="modal-content midi-modal">
            <button class="modal-close" id="midi-close" aria-label="Close MIDI options">&times;</button>
            <h2 id="midi-title">üéπ MIDI Output</h2>

            <div class="midi-section">
                <h3>Device Selection</h3>
                <div class="midi-device-selector">
                    <label for="midi-device-select">MIDI Device:</label>
                    <select id="midi-device-select" aria-label="Select MIDI output device">
                        <option value="">-- No MIDI devices found --</option>
                    </select>
                    <button id="refresh-midi-devices" class="secondary-button" aria-label="Refresh MIDI device list">
                        üîÑ Refresh Devices
                    </button>
                </div>
            </div>

            <div class="midi-section">
                <h3>Output Controls</h3>
                <div class="midi-controls">
                    <div class="slider-control">
                        <label for="midi-velocity">MIDI Velocity: <span id="midi-velocity-value">80</span></label>
                        <input type="range" id="midi-velocity" min="1" max="127" step="1" value="80">
                    </div>
                    <div class="slider-control">
                        <label for="midi-note-duration">Note Duration: <span id="midi-note-duration-value">500</span> ms</label>
                        <input type="range" id="midi-note-duration" min="100" max="2000" step="100" value="500">
                    </div>
                    <div class="slider-control">
                        <label for="midi-tempo">MIDI Tempo: <span id="midi-tempo-value">120</span> BPM</label>
                        <input type="range" id="midi-tempo" min="40" max="240" step="1" value="120">
                    </div>
                </div>
            </div>

            <div class="midi-section">
                <h3>Actions</h3>
                <div class="midi-action-buttons">
                    <button id="send-midi-notes" disabled class="secondary-button" aria-label="Send spectrum as MIDI notes">
                        üéπ Send to MIDI Device
                    </button>
                    <button id="export-midi-file" disabled class="secondary-button" aria-label="Export spectrum as MIDI file">
                        üíæ Export MIDI File
                    </button>
                </div>
                <p class="midi-info">Send spectral peaks as MIDI notes to external synthesizers or export as Standard MIDI File (.mid). Uses the Playback Mode setting. Requires Web MIDI API support for device output.</p>
            </div>

            <button id="midi-ok" class="primary-button modal-action-button">Done</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden" role="dialog" aria-labelledby="help-title" aria-modal="true">
        <div class="modal-content help-modal">
            <button class="modal-close" id="help-close" aria-label="Close help">&times;</button>
            <h2 id="help-title">‚ùì Help & Information</h2>

            <div class="help-section">
                <h3>üî¨ About This Tool</h3>
                <p>
                    FTIR spectroscopy and audio both use <strong>Fourier transforms</strong> to decompose signals
                    into frequency components. This tool maps infrared absorption spectra (molecular vibrations)
                    down to audible frequencies, revealing what molecules "sound like".
                </p>
                <p class="info-highlight" style="margin-top: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--accent-primary);">
                    <strong>Now using real data!</strong> This version includes 381 authentic FTIR spectra from the
                    <a href="https://enfsi.eu/" target="_blank" style="color: var(--accent-secondary); text-decoration: underline;">ENFSI DWG IR Library</a>
                    (European Network of Forensic Science Institutes), providing scientifically accurate molecular fingerprints.
                </p>
            </div>

            <div class="help-section">
                <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                <div class="shortcuts-grid">
                    <div class="shortcut-row">
                        <kbd>Space</kbd>
                        <span>Play / Stop</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>‚Üë</kbd> / <kbd>‚Üì</kbd>
                        <span>Navigate substances</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>A</kbd>
                        <span>Select all peaks</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>C</kbd>
                        <span>Clear peak selection</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Esc</kbd>
                        <span>Clear search/filters</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>?</kbd>
                        <span>Show this help</span>
                    </div>
                </div>
            </div>

            <div class="help-section">
                <h3>üéì Getting Started</h3>
                <button id="restart-tutorial" class="primary-button">
                    üéì Take the Tutorial
                </button>
                <p class="help-description">Learn how to use the synthesizer with a guided tour.</p>
            </div>

            <div class="help-section">
                <h3>üî¨ The Science</h3>
                <div class="science-explanation">
                    <h4>Why molecules absorb infrared light</h4>
                    <p>
                        Chemical bonds vibrate at specific frequencies. When infrared light matches these
                        vibrational frequencies, the molecule absorbs that light. Different molecular structures
                        create different absorption patterns - a unique "fingerprint".
                    </p>

                    <h4>The Fourier Transform connection</h4>
                    <p>
                        Both FTIR and audio analysis use the same mathematical tool: the Fourier Transform.
                        It decomposes complex signals into individual frequency components. In FTIR, we're
                        analyzing molecular vibrations (~10¬π¬≥ Hz). In audio, we're analyzing sound waves (~100-10000 Hz).
                    </p>

                    <h4>The sonification process</h4>
                    <ol>
                        <li>Extract absorption peaks from FTIR spectrum</li>
                        <li>Map IR wavenumbers (400-4000 cm‚Åª¬π) to audio frequencies (20-20000 Hz) logarithmically</li>
                        <li>Create oscillators at mapped frequencies with amplitudes based on absorption intensity</li>
                        <li>Synthesize the sound and visualize its FFT in real-time</li>
                    </ol>
                </div>
            </div>

            <div class="help-section">
                <h3>üìä Understanding the Mapping</h3>
                <div id="mapping-info-modal" class="mapping-info">
                    <p>Select a substance to see how infrared frequencies map to audio frequencies.</p>
                </div>
            </div>

            <button id="help-ok" class="primary-button modal-action-button">Done</button>
        </div>
    </div>

    <!-- Tutorial path selection modal -->
    <div id="tutorial-path-modal" class="modal-overlay hidden" role="dialog" aria-labelledby="tutorial-path-title" aria-modal="true">
        <div class="modal-content tutorial-path-modal">
            <button class="modal-close" id="tutorial-path-close" aria-label="Close tutorial selection">&times;</button>
            <h2 id="tutorial-path-title">Choose Your Learning Path üéì</h2>
            
            <p class="tutorial-intro-text">
                Select the perspective that interests you most:
            </p>
            
            <div class="tutorial-paths">
                <button class="tutorial-path-card" data-path="chemistry">
                    <div class="path-icon">üî¨</div>
                    <h3>Chemistry Mode</h3>
                    <p>Learn about FTIR spectroscopy, molecular vibrations, and how infrared absorption creates unique fingerprints for each substance.</p>
                    <span class="path-duration">~3-4 minutes</span>
                </button>
                
                <button class="tutorial-path-card" data-path="music">
                    <div class="path-icon">üéµ</div>
                    <h3>Music Mode</h3>
                    <p>Explore additive synthesis, frequency analysis, audio effects, and how to create unique sounds from molecular data.</p>
                    <span class="path-duration">~3-4 minutes</span>
                </button>
            </div>
            
            <p class="tutorial-help-text">
                You can restart the tutorial anytime from the help menu (press <kbd>?</kbd>)
            </p>
        </div>
    </div>

    <!-- Main application as ES6 module -->
    <script type="module" src="../src/core/app.js"></script>

    <!-- Service Worker Registration (non-module for compatibility) -->
    <script src="../src/pwa/sw-register.js"></script>
</body>
</html>
